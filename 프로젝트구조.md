## 1. 아키텍처 개요

- **Server-derived 일정 관리**: 시간 단위 일정/라벨/알림 규칙을 서버에서 강제하고, 저장 이후 큐(BullMQ)를 통해 알림·후처리에 집중한다.
- **Core vs Modules 분리**: Core는 프레임워크(런타임, DB, 큐, UI 등)를 담당하고, Modules는 비즈니스 로직만 작성한다.
- **Flow Pipeline**: “진입점 → Flow(트랜잭션) → DB Builder → 큐” 패턴을 모든 기능이 공유하여 CRUD 중복을 제거한다.

---

## 2. 디렉터리 구조

```
workwork/
├─ core/
│  ├─ runtime/     # HTTP/Queue 런타임, Route Spec, Pipeline Builder, Handler/Flow 베이스
│  ├─ db/          # DB Builder, Immutable Query, ORM 어댑터
│  ├─ queue/       # BullMQ 커넥터, Job 선언, Worker 헬퍼
│  ├─ ui/          # 캘린더·시간 블럭·설정 컴포넌트, 디자인 토큰
│  └─ config/      # ESLint, tsconfig, env 스키마
├─ modules/
│  ├─ auth/        # 로그인/회원가입, 세션·디바이스 토큰
│  ├─ profile/     # 사용자 설정(기본 라벨, 알림 템플릿, 주간 시작 요일)
│  ├─ label/       # 라벨 CRUD, 색상 규칙, 기본 알림
│  ├─ schedule/    # 월/일/시간 일정 CRUD, 라벨·알림 매핑
│  ├─ notification/# 알림 생성·전달, 방해 금지 시간, 재시도
│  ├─ calendar/    # 월간/일간 뷰 데이터 집계, 스크롤 상태 유지
│  └─ telemetry/   # 로깅, 감사, 사용자 행동 분석(선택)
├─ shared/         # DTO, 시간 유틸, 라벨 규칙, Validation 스키마
├─ apps/
│  ├─ server/      # core/runtime + modules 조립 → 빌드 산출물(dist)
│  └─ web/         # React 클라이언트 빌드 산출물(dist, core/ui 사용)
├─ infra/          # Docker Compose(Postgres/Redis), IaC, 배포 설정
└─ scripts/        # 마이그레이션, 큐 관리, 배포 자동화 스크립트
```

---

## 3. Flow Pipeline

| 단계 | 역할 | 패턴 | 구현 위치 |
| --- | --- | --- | --- |
| Route Spec | HTTP/Queue 계약 선언 | Declarative Config | `core/runtime/routes.ts`, `core/queue/jobs.ts` |
| Pipeline Builder | 공통 미들웨어·Context 구성 | Builder + Chain | `core/runtime/pipeline` |
| Handler | 요청 파싱·권한·Flow 호출 | Template Method | `core/runtime/handler`, `modules/*/handler` |
| Flow | 트랜잭션/감사/큐 브리지 | Application Service / Unit of Work | `core/runtime/flow`, `modules/*/flow` |
| DB Builder | 공통 쿼리 DSL | Query Builder | `core/db/builder` |
| Immutable Query | 자주 쓰이는 쿼리 모듈화 | Repository | `core/db/queries`, `modules/*/queries` |
| Repository/ORM | 실제 데이터 접근 | Repository | `modules/*/repository`, `core/db/orm` |
| Queue Bridge | BullMQ 작업 등록·소비 | Event Bridge | `core/queue/bridge`, `modules/*/flow` |

> **핵심 흐름**: Route Spec → Pipeline Builder → Handler → Flow → DB Builder/Immutable Query → Repository/ORM → Queue Bridge → Worker

---

## 4. 모듈 설계

### auth
- 기능: 회원가입, 로그인, 비밀번호 재설정, 세션/토큰 관리, 디바이스 푸시 토큰 저장.
- Flow 예시: `signUp`, `login`, `refreshToken`, `registerDevice`.
- Queue 연동: 로그인 상태 변경 시 알림 토큰 등록/삭제 작업 큐잉.

### profile
- 기능: 기본 라벨 세트, 기본 알림 템플릿, 주간 시작 요일, 방해 금지 시간 등 사용자 설정.
- Flow 예시: `updatePreferences`, `toggleNotificationChannel`.
- Queue 연동: 설정 변경 시 관련 일정/알림 재계산 작업.

### label
- 기능: 라벨 CRUD, 색상 대비 검증, 기본 알림 on/off, 라벨 템플릿.
- Flow 예시: `createLabel`, `updateLabel`, `archiveLabel`.
- Immutable Query: 라벨별 알림 설정 조회, 라벨 사용 현황.

### schedule
- 기능: 월/일/시간 일정 CRUD, 라벨·알림 매핑, 시간 블럭 충돌 검사.
- Flow 예시: `createTimeBlock`, `updateTimeBlock`, `moveTimeBlock`.
- Queue 연동: 일정 생성/수정 시 알림 생성 Job 큐잉, 반복 일정 확장.

### notification
- 기능: 알림 메시지 생성, 미리 알림 시간 계산, 채널별 전송 상태 관리, 방해 금지 시간 준수.
- Flow 예시: `scheduleNotification`, `sendNotification`, `retryFailed`.
- Worker: BullMQ Job을 소비해 알림 발송, 실패 재시도, 로그 기록.

### calendar
- 기능: 월간/일간 데이터 집계, 스크롤 상태 유지, UI에 필요한 요약 정보 제공.
- Flow 예시: `getMonthlyView`, `getDailyView`.
- Immutable Query: 특정 기간의 일정 카운트, 시간대별 라벨 분포.

### telemetry (선택)
- 기능: 사용자 행동 이벤트, 알림 전송 로그, 에러 추적.
- Flow 예시: `logEvent`, `recordNotificationStatus`.

---

## 5. 앱 구성

### apps/server
- core/runtime과 modules를 조립한 빌드 결과(dist).
- HTTP 서버/Queue 워커 모두 같은 런타임에서 구동되며, 배포 스크립트만 여기에 위치.

### apps/web
- core/ui 컴포넌트와 shared DTO를 사용해 React 앱을 구성.
- 월·일·시간 뷰, 라벨/알림 설정 화면, 설정 페이지를 제공하고 dist 결과를 apps/web에 저장.

---

## 6. 데이터·설정 흐름

1. `shared`에서 DTO, 라벨 규칙, 시간 유틸을 정의 → web/runtime/queue 모두 공유.
2. `core/runtime`이 HTTP/Queue 진입점과 Pipeline을 제공 → 모듈 개발자는 Flow만 구현.
3. `core/db`가 DB Builder/ORM 추상화를 제공 → 저장/조회 패턴을 단일 DSL로 처리.
4. `core/queue`가 BullMQ 커넥터와 Worker 헬퍼를 제공 → 저장 이후 작업을 일관 처리.
5. `core/ui`가 캘린더/시간 블럭 컴포넌트와 디자인 토큰을 제공 → 프런트 개발자는 조립만 수행.
6. `core/config`로 ESLint/tsconfig/env 스키마를 공유 → 빌드 규칙 통일.
7. `infra`와 `scripts`가 Postgres/Redis 실행, 마이그레이션, 배포를 담당.

---

## 7. 기대 효과

- **비즈니스 집중**: 개발자는 `modules/*`에서 도메인 Flow만 작성하고, core가 런타임/DB/큐를 처리하므로 API/워커 구현을 신경 쓸 필요가 없다.
- **저장 이후 안정성**: Flow가 큐 브리지까지 책임져 시간 블럭 저장 시 BullMQ 작업이 자동 등록된다.
- **재사용성**: core/ui와 Flow Pipeline이 공통 UX/로직을 제공해 월/일/시간 뷰, 라벨/알림 기능을 빠르게 확장할 수 있다.
- **확장성**: 새로운 기능은 모듈(Handler/Flow/Query) 추가만으로 확장되며, 웹/워커가 동일 규칙을 자동으로 사용한다.
